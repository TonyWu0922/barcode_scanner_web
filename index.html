<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OCR æ¢ç¢¼è¾¨è­˜å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
</head>

<body>
    <h2>ä¸Šå‚³å•†å“è³‡æ–™ (Excel)</h2>
    <input type="file" id="excelFile" accept=".xlsx" />

    <h2>æ–‡å­—è¾¨è­˜æ¢ç¢¼æ•¸å­— (OCR)</h2>
    <button id="startOcrBtn">ğŸ“¸ å•Ÿå‹•è¾¨è­˜</button>
    <video id="video" autoplay muted playsinline
        style="display: none; width: 300px; height: auto; border: 1px solid gray;"></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <h3>è¾¨è­˜çµæœ</h3>
    <pre id="result">å°šæœªè¾¨è­˜</pre>

    <script>
        async function startOcrScan() {
            resultDiv.textContent = "ğŸ“· é–‹å•Ÿé¡é ­ä¸­...";
            startOcrBtn.disabled = true;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                video.style.display = "block";

                // ç­‰å¾…ç•«é¢ç©©å®š
                setTimeout(async () => {
                    const context = canvas.getContext("2d");
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);

                    // åªå–ä¸­å¤®åº•éƒ¨å€å¡Šï¼ˆæ¢ç¢¼æ•¸å­—é€šå¸¸åœ¨åº•éƒ¨ï¼‰
                    const cropHeight = 80; // å€å¡Šé«˜åº¦
                    const cropWidth = canvas.width * 0.8; // å¯¬åº¦ç‚ºç•«é¢çš„ 80%
                    const cropX = (canvas.width - cropWidth) / 2;
                    const cropY = canvas.height - cropHeight - 30; // ç•«é¢åº•éƒ¨ä¸Šä¾†ä¸€é»

                    const imageData = context.getImageData(cropX, cropY, cropWidth, cropHeight);
                    const tempCanvas = document.createElement("canvas");
                    tempCanvas.width = cropWidth;
                    tempCanvas.height = cropHeight;
                    const tempCtx = tempCanvas.getContext("2d");
                    tempCtx.putImageData(imageData, 0, 0);

                    const dataUrl = tempCanvas.toDataURL("image/png");

                    stream.getTracks().forEach(track => track.stop());
                    video.style.display = "none";
                    resultDiv.textContent = "ğŸ” æ­£åœ¨é€²è¡Œæ–‡å­—è¾¨è­˜...";

                    const result = await Tesseract.recognize(dataUrl, "eng", {
                        tessedit_char_whitelist: "0123456789",
                    });

                    const rawText = result.data.text.replace(/\D/g, "");
                    const matches = rawText.match(/\d{13}/g); // æ‰¾å‡ºæ‰€æœ‰ 13 ç¢¼æ•¸å­—

                    if (matches && matches.length > 0) {
                        const code = matches[0];
                        const product = productData[code] || {
                            itemNumber: "âŒ æ‰¾ä¸åˆ°å“è™Ÿ",
                            itemName: "âŒ æ‰¾ä¸åˆ°å“å"
                        };
                        resultDiv.textContent = `æ¢ç¢¼ï¼š${code}\nå“è™Ÿï¼š${product.itemNumber}\nå“åï¼š${product.itemName}`;
                    } else {
                        resultDiv.textContent = `ğŸš« ç„¡æ³•è¾¨è­˜æœ‰æ•ˆçš„ 13 ç¢¼æ¢ç¢¼ï¼ˆå–å¾—å…§å®¹ï¼š${rawText}ï¼‰`;
                    }

                    startOcrBtn.disabled = false;
                }, 2500); // ç­‰ 2.5 ç§’å°ç„¦
            } catch (err) {
                resultDiv.textContent = `ğŸš« é¡é ­ç„¡æ³•å•Ÿå‹•ï¼š${err.message}`;
                startOcrBtn.disabled = false;
            }
        }

        startOcrBtn.addEventListener("click", startOcrScan);
    </script>
</body>

</html>